<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Create routes to access the Node API
 */

//Library Requirements
var express = require('express');
var router = express.Router();
const HttpStatus = require('http-status-codes');
const Rx = require('rxjs');
const {
    take,
    mergeMap
} = require('rxjs/operators');
const sw = require('stopword');

//Parser Service
const parser = require('../services/parser.service');

//Cache Service
const CacheService = require('../services/cache.service');
const ttl = 60 * 60 * 1; // cache for 1 Hour
const Maxmemory = 50; //cache for 50 Mb 
const cache = new CacheService(ttl, Maxmemory); // Create a new cache service instance

//POST entry form 
router.post('/', function(req, res, next) {

    //get request words
    const raw_req_words = req.body.words;
    const split_character = '|';
    const list_raw_req_words = raw_req_words.split(split_character)

    let list_req_words = sw.removeStopwords(list_raw_req_words, sw.fr); //remove useless words
    list_req_words = list_req_words.filter(function(elem, index, self) { //remove repeated words
        return index === self.indexOf(elem);
    })

    //get similar words
    const finalResult = [];
    Rx.from(list_req_words)
        .pipe(
            mergeMap((word) => {
                const cacheContent = cache.get(word); //return null if don't find a word in the cache
                if (cacheContent) {
                    console.log('cache:');
                    return (new Promise(function(resolve, reject) {
                        resolve(cacheContent)
                    })); //send cache
                } else {
                    console.log('parser:');
                    return (parser(word, 'fr')); //send wiki relevant words {word:..., synonymes : ..., troponymes : ...}
                }
            }),
            take(list_req_words.length) //call function() when mergeMap finishes
        )
        .subscribe(
            //concatenate objects returned by mergeMap
            function(x) {
                if (x.originWord) {
                    cache.set(x.originWord[0], x);
                }
                finalResult.push(x);
            },
            //when an error is returned
            function(err) {
                console.log('Error: ' + err);
            },
            //send relevant words when mergeMap finishes
            function() {
                console.log('Completed');
                console.log('cache Stats:', cache.getStats());
                res.status(HttpStatus.OK).send({
                    relevantWords: finalResult
                });
            });
});

module.exports = router;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Parser.html">Parser</a></li></ul><h3>Classes</h3><ul><li><a href="Cache.html">Cache</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Nov 05 2018 14:52:30 GMT+0100 (Paris, Madrid)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
